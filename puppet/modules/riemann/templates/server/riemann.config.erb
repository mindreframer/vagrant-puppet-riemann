; vim: filetype=clojure
; http://riemann.io/api/riemann.server.html

(logging/init :file "/var/log/riemann.log")

(tcp-server :host "<%= scope.lookupvar('riemann::params::riemann_server_ip') %>" :port 5555)
(udp-server :host "<%= scope.lookupvar('riemann::params::riemann_server_ip') %>" :port 5555)
(ws-server :host "<%= scope.lookupvar('riemann::params::riemann_server_ip') %>" :port 5556)

(periodically-expire 10)

(let [client (tcp-client :host "<%= scope.lookupvar('riemann::params::riemann_server_ip') %>")
      ; Keep events for 5 minutes by default
      index (default :ttl 300 (update-index (index)))]

  (streams
    ;(with {:metric_f 1 :host nil :state "ok" :service "events/sec"}
    ;  (rate 5 index))

    (where (service #"^per")
      (percentiles 5 [0 0.5 0.95 0.99 1]
        index))

    ; Log expired events.
    (expired
      (fn [event] (info "expired" event)))

    ; https://gist.github.com/aaronfeng/4583640 --> not working for me...
    ; (let [hosts (atom #{})]
    ;   (fn [event]
    ;     (swap! hosts conj (:host event))
    ;     (prn :hosts @hosts)
    ;     (index {:service "unique hosts"
    ;             :time (unix-time)
    ;             :metric (count @hosts)})))
    index
))


